<!DOCTYPE html>
<html>
  <head>
    <title>Student Management System</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{url_for ('static', filename='bsit.css') }}"
    />

    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='dashboard.css') }}"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='index.css') }}"
    />
    <style>
      .time-records-table {
        width: 100%;
        border-collapse: collapse;
      }

      .time-records-table th {
        background-color: #f5f5f5;
        color: black;
        padding: 12px;
        text-align: left;
        border-bottom: 2px solid #ddd;
      }

      .time-records-table td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
      }

      .time-records-table tbody tr:hover {
        background-color: #f9f9f9;
      }
    </style>
  </head>
  <body>
    <div class="sidebar-container">
      <div class="sidebar active">
        <div class="menu-btn">
          <i class="ph-bold ph-caret-left"></i>
        </div>
        <div class="head">
          <div class="user-img">
            <img src="{{ url_for('static', filename='imgs.png') }}" alt="" />
          </div>
          <div class="user-details">
            <p class="title">UCU-MIS</p>
          </div>
        </div>
        {% include 'sidebar.html' %}
      </div>
    </div>

    <div class="main">
      <div class="header">
        <h1>{{ course_name }}</h1>
      </div>
      <div class="search-container">
        <input
          type="text"
          id="searchBar"
          placeholder="Search for student ID or name.."
        />
      </div>

      <!-- Replace the date range div with a single date filter -->
      <div class="date-range">
        <form id="date-filter-form">
          <div class="date-input-group">
            <label>Filter by Date:</label>
            <div class="input-with-button">
              <input type="date" id="filter-date" class="form-control date-input" />
            </div>
          </div>
          <button type="submit" class="btn btn-dark">Filter</button>
          <button type="button" id="reset-button" class="btn btn-secondary">Clear Filter</button>
        </form>
      </div>

      <button class="btn btn-success" id="generatePDF">Generate PDF</button>
      <button class="btn btn-primary" id="generateExcel">Generate Excel</button>
      <div class="table-container" style="margin-left: 20px">
        <h2>Student List</h2>
        <table id="studentTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Course</th>
              <th>Gender</th>
              <th>Year</th>
              <th>Date</th>
              <th>Time</th>
              <th>Total Entered</th>
              <th>Total Exit</th>
              <th>Image</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="studentTableBody">
            <!-- Table rows will be inserted here by JavaScript -->
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <button id="prevPage" onclick="changePage(-1)">Previous</button>
        <span id="pageDisplay"></span>
        <button id="nextPage" onclick="changePage(1)">Next</button>
      </div>
    </div>

    <!-- Time Records Modal -->
    <div id="timeRecordsModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Time Records</h2>
        <div class="sort-controls">
          <button id="sortDateBtn" class="btn">Sort by Date ↕️</button>
        </div>
        <table id="timeRecordsTable" class="time-records-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time In</th>
              <th>Time Out</th>
              <th>Duration</th>
            </tr>
          </thead>
          <tbody id="timeRecordsTableBody">
            <!-- Time records will be inserted here -->
          </tbody>
        </table>
      </div>
    </div>
    <script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.js"
      integrity="sha512-8Z5++K1rB3U+USaLKG6oO8uWWBhdYsM3hmdirnOEWp8h2B1aOikj5zBzlXs8QOrvY9OxEnD2QDkbSKKpfqcIWw=="
      crossorigin="anonymous"
    ></script>
    <!-- ====== ionicons ======= -->
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
    <script
      src="https://cdn.socket.io/4.7.5/socket.io.min.js"
      integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO"
      crossorigin="anonymous"
    ></script>
    <script src="{{ url_for('static', filename='sidebar.js') }}"></script>

    <script>

            const course = {{ course | tojson }};

            document.getElementById("generateExcel").addEventListener("click", function () {
              // Get the table data
              const tableData = [];
              const rows = document.querySelectorAll("#studentTable tbody tr:not([style*='display: none'])");
              for (const row of rows) {
                  const cells = row.querySelectorAll("td");
                  const rowData = [
                      cells[0].textContent.trim(), // ID
                      cells[1].textContent.trim(), // Name
                      cells[2].textContent.trim(), // Course
                      cells[3].textContent.trim(), // Gender
                      cells[4].textContent.trim(), // Year
                      cells[5].textContent.trim(), // Date
                      cells[6].textContent.trim(), // Time
                      cells[7].textContent.trim(), // Total Entered
                  ];
                  tableData.push(rowData);
              }
  
              // Define the columns for the Excel sheet
              const columns = ["ID", "Name", "Course", "Gender", "Year", "Date", "Time", "Total Entered"];
  
              // Create a new workbook and a worksheet
              const wb = XLSX.utils.book_new();
              const ws = XLSX.utils.aoa_to_sheet([columns, ...tableData]);
  
              // Append the worksheet to the workbook
              XLSX.utils.book_append_sheet(wb, ws, "Student List");
  
              // Generate the Excel file and trigger a download
              XLSX.writeFile(wb, `attendance_${course}.xlsx`);
          });

              document.getElementById("generatePDF").addEventListener("click", async function () {
                  const { jsPDF } = window.jspdf;

                  // Create a new jsPDF instance (landscape, inches, letter size)
                  const doc = new jsPDF({
                      orientation: "landscape",
                      unit: "in",
                      format: "letter",
                  });

                  // Set the title of the PDF
                  doc.setFontSize(18);
                  doc.text("{{ course_name }}", 0.5, 0.5);

                  // Get the table data
                  const tableData = [];
                  const rows = document.querySelectorAll("#studentTable tbody tr:not([style*='display: none'])");
                  for (const row of rows) {
                      const cells = row.querySelectorAll("td");
                      const rowData = [
                          cells[0].textContent.trim(), // ID
                          cells[1].textContent.trim(), // Name
                          cells[2].textContent.trim(), // Course
                          cells[3].textContent.trim(), // Gender
                          cells[4].textContent.trim(), // Year
                          cells[5].textContent.trim(), // Date
                          cells[6].textContent.trim(), // Time
                          cells[7].textContent.trim(), // Total Entered
                      ];
                      tableData.push(rowData);
                  }

                  // Define the columns for the PDF table
                  const columns = [
                      { header: "ID", dataKey: "id" },
                      { header: "Name", dataKey: "name" },
                      { header: "Course", dataKey: "course" },
                      { header: "Gender", dataKey: "gender" },
                      { header: "Year", dataKey: "year" },
                      { header: "Date", dataKey: "date" },
                      { header: "Time", dataKey: "time" },
                      { header: "Total Entered", dataKey: "totalEntered" },
                  ];

                  // Configure AutoTable options
                  const options = {
                      startY: 0.7, // Start the table below the title
                      head: [columns.map((col) => col.header)],
                      body: tableData,
                  };

                  // Generate the table in the PDF
                  doc.autoTable(options);

                  // Open a new tab and write the PDF content to it
                  const string = doc.output('datauristring');
                  const iframe = `<iframe width='100%' height='100%' src='${string}'></iframe>`;
                  const newWindow = window.open();
                  newWindow.document.open();
                  newWindow.document.write(iframe);
                  newWindow.document.close();
              });

              document.getElementById("searchBar").addEventListener(
              "keyup",
              debounce(function () {
                const searchQuery = document.getElementById("searchBar").value.toLowerCase();
                const rows = document.querySelectorAll("#studentTable tbody tr");

                rows.forEach((row) => {
                  const studentId = row.querySelector("td:nth-child(1)").textContent.toLowerCase();
                  const studentName = row.querySelector("td:nth-child(2)").textContent.toLowerCase();

                  if (studentId.includes(searchQuery) || studentName.includes(searchQuery)) {
                    row.style.display = "";
                  } else {
                    row.style.display = "none";
                  }
                });
              }, 300) // Adjust the debounce delay as needed
            );

              function debounce(func, wait) {
                let timeout;
                return function (...args) {
                  const context = this;
                  clearTimeout(timeout);
                  timeout = setTimeout(() => func.apply(context, args), wait);
                };
              }

                        function changePage(direction) {
                            currentPage += direction;
                            displayTable();
                        }

                        function toggleDropdown(menuId) {
                    var dropdown = document.getElementById('dropdown_' + menuId);
                    dropdown.classList.toggle('active');
                        }


                                // Initial table display
                                //displayTable();
                                const socket = io.connect('http://' + document.domain + ':' + location.port);
                                const course_mapping = {{ course_mapping | tojson }};
                                socket.on(`update_${course}_students`, (data) => {
                                    const students = data;
                                    const convertedStudents = data ? Object.values(data) : [];
                                    console.log(students);
                                    generateTableRows(convertedStudents);
                                });

                                function formatDateTime(dateTime) {
                                    const date = new Date(dateTime);
                                    const today = new Date();
                                    
                                    // Reset if it's a new day
                                    if (dateTime && !isSameDay(date, today)) {
                                        return { formattedDate: 'mm/dd/yy', formattedTime: '00:00' };
                                    }
                                    
                                    if (isNaN(date.getTime())) {
                                        return { formattedDate: 'mm/dd/yy', formattedTime: '00:00' };
                                    }
                                    
                                    const formattedDate = date.toLocaleDateString();
                                    const formattedTime = date.toLocaleTimeString();
                                    return { formattedDate, formattedTime };
                                }

                                // Helper function to check if two dates are the same day
                                function isSameDay(date1, date2) {
                                    return date1.getFullYear() === date2.getFullYear() &&
                                           date1.getMonth() === date2.getMonth() &&
                                           date1.getDate() === date2.getDate();
                                }

                                function generateTableRows(students) {
                                  // Sort students by last_entered_time in descending order (most recent first)
                                  // and handle null/undefined last_entered_time values
                                  students.sort((a, b) => {
                                    // If either student hasn't entered, move them to the bottom
                                    if (!a.last_entered_time && !b.last_entered_time) return 0;
                                    if (!a.last_entered_time) return 1;
                                    if (!b.last_entered_time) return -1;

                                    // Compare dates for students who have entered
                                    const timeA = new Date(a.last_entered_time);
                                    const timeB = new Date(b.last_entered_time);
                                    
                                    // Check if the dates are valid before comparing
                                    if (isNaN(timeA.getTime()) && isNaN(timeB.getTime())) return 0;
                                    if (isNaN(timeA.getTime())) return 1;
                                    if (isNaN(timeB.getTime())) return -1;
                                    
                                    return timeB - timeA;
                                  });

                                  const tableBody = document.getElementById('studentTableBody');
                                  tableBody.innerHTML = '';

                                  students.forEach((student, index) => {
                                      const { formattedDate, formattedTime } = formatDateTime(student.last_entered_time);
                                      const studentId = student.id_number || `student_${index}`;
                                      const studentName = `${student.first_name || ''} ${student.middle_initial || ''} ${student.last_name || ''}`.trim();
                                      const placeholderImage = student.gender.toLowerCase() === 'female'
                                          ? 'https://static.vecteezy.com/system/resources/previews/042/332/098/original/default-avatar-profile-icon-grey-photo-placeholder-female-no-photo-images-for-unfilled-user-profile-greyscale-illustration-for-socail-media-web-vector.jpg'
                                          : 'https://www.strasys.uk/wp-content/uploads/2022/02/Depositphotos_484354208_S.jpg';
                              
                                      // Reset today_count if it's a new day
                                      const today_count = isSameDay(new Date(student.last_entered_time), new Date()) 
                                          ? (student.today_count || 0) 
                                          : 0;
                                      const today_exit = isSameDay(new Date(student.last_entered_time), new Date())
                                          ? (student.exit_count || 0)
                                          : 0;
                                      const row = `
                                          <tr>
                                              <td>${studentId}</td>
                                              <td>${studentName}</td>
                                              <td>${course_mapping[student.course]}</td>
                                              <td>${student.gender}</td>
                                              <td>${student.school_year || student.year}</td>
                                              <td>${formattedDate}</td>
                                              <td>${formattedTime}</td>
                                              <td>${today_count}</td>
                                              <td>${today_exit}</td>
                                              <td>
                                                  <img src="${student.image_url || placeholderImage}" id="img_${studentId}" alt="Student Image" width="100" onerror="this.onerror=null;this.src='${placeholderImage}';">
                                              </td>
                                              <td><button class="btn btn-info" onclick="showStudentInfo('${studentId}')">Info</button></td>
                                          </tr>
                                      `;
                                      tableBody.insertAdjacentHTML('beforeend', row);
                                  });
                              }

                  // Modify the showStudentInfo function to call showTimeRecords
                  function showStudentInfo(studentId) {
                    const student = convertedStudents.find(s => s.id_number === studentId);
                    if (student) {
                      showTimeRecords(studentId, student.course, student.program);
                    } else {
                      alert('Student information not found.');
                    }
                  }

                                const students = {{ initial_data | tojson }};
                                const convertedStudents = students ? Object.values(students) : [];
                                generateTableRows(convertedStudents);
                                console.log(convertedStudents);


                                // Function to show the time records modal
            async function showTimeRecords(studentId, course, program) {
              const modal = document.getElementById('timeRecordsModal');
              const closeBtn = modal.querySelector('.close');
              const tableBody = document.getElementById('timeRecordsTableBody');
              let records = []; // Store records globally in the function scope

              // Clear previous records
              tableBody.innerHTML = '';

              try {
                const response = await fetch(`{{ url_for('main.time_records', course='__course__', program='__program__', student_id='__student_id__') }}`
                  .replace('__course__', encodeURIComponent(course))
                  .replace('__program__', encodeURIComponent(program))
                  .replace('__student_id__', encodeURIComponent(studentId)));

                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data[studentId] && data[studentId].records && data[studentId].records.length > 0) {
                  const studentName = data[studentId].name;
                  records = data[studentId].records;

                  // Add student name to the modal
                  const modalTitle = modal.querySelector('h2');
                  modalTitle.textContent = `Time Records for ${studentName}`;

                  // Sort records by date in descending order (most recent first)
                  records.sort((a, b) => new Date(b.date) - new Date(a.date));
                  
                  // Function to render the records
                  const renderRecords = (recordsToRender) => {
                    tableBody.innerHTML = ''; // Clear existing rows
                    recordsToRender.forEach(record => {
                      const timeIn = record.time_in ? new Date(`2000-01-01 ${record.time_in}`).toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                      }) : 'N/A';

                      const timeOut = record.time_out ? new Date(`2000-01-01 ${record.time_out}`).toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                      }) : 'N/A';

                      const row = `
                        <tr>
                          <td>${record.date}</td>
                          <td>${timeIn}</td>
                          <td>${timeOut}</td>
                          <td>${record.duration}</td>
                        </tr>
                      `;
                      tableBody.insertAdjacentHTML('beforeend', row);
                    });
                  };

                  // Initial render
                  renderRecords(records);

                  // Sort button click handler
                  let sortAscending = false;
                  document.getElementById('sortDateBtn').onclick = () => {
                    sortAscending = !sortAscending;
                    records.sort((a, b) => {
                      const comparison = new Date(a.date) - new Date(b.date);
                      return sortAscending ? comparison : -comparison;
                    });
                    renderRecords(records);
                  };

                  modal.style.display = 'block';
                } else {
                  alert('No time records found for this student.');
                }
              } catch (error) {
                console.error('Error fetching time records:', error);
                alert('Error fetching time records. Please try again.');
              }

              // Close modal when clicking the close button
              closeBtn.onclick = function() {
                modal.style.display = 'none';
              }

              // Close modal when clicking outside of it
              window.onclick = function(event) {
                if (event.target == modal) {
                  modal.style.display = 'none';
                }
              }
            }

            // Add date filter functionality
            document.getElementById('date-filter-form').addEventListener('submit', function(e) {
                e.preventDefault();
                filterTableByDate();
            });

            document.getElementById('reset-button').addEventListener('click', function() {
                document.getElementById('filter-date').value = '';
                const rows = document.querySelectorAll("#studentTable tbody tr");
                rows.forEach(row => row.style.display = "");
            });

            function filterTableByDate() {
                const filterDate = new Date(document.getElementById('filter-date').value);
                filterDate.setHours(0, 0, 0); // Start of the selected date
                
                const rows = document.querySelectorAll("#studentTable tbody tr");
                
                rows.forEach(row => {
                    const dateCell = row.querySelector("td:nth-child(6)").textContent;
                    if (dateCell === 'Not yet entered today') {
                        row.style.display = "none";
                    } else {
                        const rowDate = new Date(dateCell);
                        // Compare only the date part (ignore time)
                        if (rowDate.toDateString() === filterDate.toDateString()) {
                            row.style.display = "";
                        } else {
                            row.style.display = "none";
                        }
                    }
                });
            }
    </script>
  </body>
</html>